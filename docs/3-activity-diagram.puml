@startuml
|Pasien|
start
:Datang ke Puskesmas;
:Menuju Loket Pendaftaran;
|Petugas Pendaftaran|
:Cek Status Pasien;
if (Pasien Baru?) then (Ya)
    :Isi Data Identitas Baru;
    |Sistem|
    :Generate No. RM Baru;
else (Tidak (Pasien Lama))
    |Petugas Pendaftaran|
    :Verifikasi Data Pasien Lama;
endif
|Petugas Pendaftaran|
:Tanya Poli Tujuan;
:Tanya Metode Pembayaran;
if (Metode Pembayaran?) then (BPJS)
    :Input No. BPJS (13 digit);
    |Sistem|
    :Auto-generate No SEP Lokal;
    :Simpan Klaim BPJS (status: pending);
else (Umum)
    |Sistem|
    :Simpan sebagai kunjungan Umum;
endif
|Sistem|
:Simpan Data Kunjungan;
|Petugas Pendaftaran|
:Cetak Nomor Antrean;
|Pasien|
:Menunggu di Ruang Tunggu;
:Masuk Ruang Pemeriksaan;
|Dokter|
:Lihat Data & Rekam Medis;
:Periksa & Catat Tanda Vital;
:Diagnosis & Input Rekam Medis;
if (Perlu Obat?) then (Ya)
    :Buat Resep Obat;
    note right
        Resep tersimpan dengan status 'menunggu'
    end note
else (Tidak)
    ' Tidak ada resep
endif

' === PERCABANGAN ALUR BPJS vs UMUM ===
|Sistem|
if (Metode Bayar?) then (BPJS)
    ' BPJS: SKIP KASIR
    if (Ada Resep?) then (Ya)
        :Update Status → 'obat';
        |Pasien|
        :Menuju Farmasi;
        |Apoteker|
        :Ambil Data Resep;
        :Cek Stok Obat;
        if (Stok Cukup?) then (Ya)
            :Siapkan Obat;
            :Serahkan Obat ke Pasien;
            |Sistem|
            :Kurangi Stok Obat;
            :Update Status → 'selesai';
        else (Tidak)
            |Apoteker|
            :Tandai 'Obat Tidak Lengkap';
            :Jelaskan ke Pasien;
            |Sistem|
            :Update Status → 'selesai';
        endif
    else (Tidak)
        :Update Status → 'selesai';
        note right
            BPJS tanpa resep langsung pulang
        end note
    endif
    |Pasien|
    :Meninggalkan Puskesmas;
    stop
else (Umum)
    ' UMUM: KE KASIR DULU
    :Update Status → 'bayar';
    |Pasien|
    :Menuju Loket Pembayaran;
    |Petugas Pendaftaran (Kasir)|
    :Tampilkan Invoice;
    |Sistem|
    :Hitung Total Biaya;
    note right
        Total = Tarif Poli + Biaya Obat
    end note
    |Petugas Pendaftaran (Kasir)|
    :Input Jumlah Bayar Tunai;
    |Sistem|
    :Hitung Kembalian Otomatis;
    |Petugas Pendaftaran (Kasir)|
    :Terima Bayar & Berikan Kembalian;
    |Sistem|
    :Simpan Record Pembayaran (status: Lunas);
    
    if (Ada Resep?) then (Ya)
        :Update Status → 'obat';
        |Pasien|
        :Menuju Farmasi;
        |Apoteker|
        :Ambil Data Resep;
        :Cek Stok Obat;
        if (Stok Cukup?) then (Ya)
            :Siapkan Obat;
            :Serahkan Obat ke Pasien;
            |Sistem|
            :Kurangi Stok Obat;
            :Update Status → 'selesai';
        else (Tidak)
            |Apoteker|
            :Tandai 'Obat Tidak Lengkap';
            :Jelaskan ke Pasien;
            |Sistem|
            :Update Status → 'selesai';
        endif
    else (Tidak)
        :Update Status → 'selesai';
        note right
            Umum tanpa resep, selesai setelah bayar
        end note
    endif
    |Pasien|
    :Meninggalkan Puskesmas;
    stop
endif
@enduml